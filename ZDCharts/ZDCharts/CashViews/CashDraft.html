<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" />
    <title>资金申请</title>
    <link href="../Content/bootstrap.min.css" rel="stylesheet" />
    <link href="../Content/bootstrap-select.min.css" rel="stylesheet" />
    <link href="../Content/bootstrap-switch/bootstrap3/bootstrap-switch.min.css" rel="stylesheet" />
    <link href="../Content/myStyle.css" rel="stylesheet" />
    <script src="../Scripts/jquery-2.1.3.min.js"></script>
    <script src="../Scripts/bootstrap.min.js"></script>
    <script src="../Scripts/bootstrap-select.min.js"></script>
    <script src="../Scripts/bootstrap-switch.min.js"></script>
    <script src="../Scripts/spin.min.js"></script>
    <script src="../Scripts/myjs.js"></script>
    <script src="../Scripts/DataTables/jquery.dataTables.min.js"></script>
    <link href="../Content/DataTables/css/jquery.dataTables.min.css" rel="stylesheet" />

    <script src="../Scripts/moment.min.js"></script>
    <script src="../Scripts/daterangepicker.js"></script>
    <link href="../Content/daterangepicker-bs3.css" rel="stylesheet" />

    <script type="text/javascript">
        var _userinfo = eval("(" + $('#userinfo', parent.document).val() + ")");
        $(document).ready(function () {
            $('#dvtable').dataTable({
                "sPaginationType": "full_numbers",
                "processing": true,//显示进度条
                "scrollX": true,//水平滚动条
                //"bAutoWidth": false,//自动列宽
                "serverSide": true,//发送服务器请求
                "ajax": {
                    "url": "../handlers/Customer.ashx",
                    "type": "POST",
                    "data": { Action: 'GetContractListByCompany' }
                },
                //列集合
                //"aoColumns": [{ "mDataProp": "ID" }, { "mDataProp": "Name", 'sClass': "text-right" }],
                "columns": [
                            { "data": "Customer" },
                            { "data": "Total" },
                            { "data": "CreatedDate" },
                            { "data": "IsFinished" }
                ],
                //汉化
                "language":
                 {
                     "sLengthMenu": "每页显示 _MENU_ 条记录",
                     "sZeroRecords": "抱歉， 没有找到",
                     "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                     "sInfoEmpty": "没有数据",
                     "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                     "oPaginate": {
                         "sFirst": "<button class='btn btn-default'><span class='glyphicon glyphicon-step-backward' aria-hidden='true'></span></button>",
                         "sPrevious": "<button class='btn btn-default'><span class='glyphicon glyphicon-chevron-left' aria-hidden='true'></span></button>",
                         "sNext": "<button class='btn btn-default'><span class='glyphicon glyphicon-chevron-right' aria-hidden='true'></span></button>",
                         "sLast": "<button class='btn btn-default'><span class='glyphicon glyphicon-step-forward' aria-hidden='true'></span></button>"
                     },
                     "sZeroRecords": "没有检索到数据",
                     "sProcessing": "<img src='../Images/loading.gif'>加载中...",
                     "sSearch": "查找"
                 },
                //请求处理函数
                "fnServerData": function retrieveData(sSource, aoData, fnCallback) {
                    // 将客户名称加入参数数组
                    //aoData.push( { "name": "customerName", "value": "asdas" } );//添加自己的额外参数
                    $.ajax({
                        "type": "POST",
                        "url": "../handlers/Customer.ashx",
                        "dataType": "json",
                        "data": { Action: 'GetContractListByCompany', UserInfo: JSON.stringify(_userinfo), p: JSON.stringify(aoData) }, // 以json格式传递
                        "success": function (resp) {
                            //alert(JSON.stringify(resp));
                            fnCallback(resp.data);
                        }
                    });
                }
            });
            try {

            } catch (e) {
                alert(e.message);
            }

            //选中行变色 单行
            $('table tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                }
                else {
                    $('table tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            });

            //添加按钮
            $('#toolbtn_add').click(function () {
                $('#customerCollapse').collapse('toggle');
                //日期控件格式设置 暂时不用
                //$('input[name="daterange"]').daterangepicker({
                //    singleDatePicker: true,
                //    format: 'YYYY-MM-DD',
                //    showDropdowns: true,
                //    minDate: '2010-1-1',
                //    maxDate: '2020-12-31',
                //    endDate: moment(),//new Date().getFullYear().toString() + "-" + new Date().getMonth().toString() + "-" + new Date().getDate().toString()
                //    locale: {
                //        applyLabel: 'Submit',
                //        cancelLabel: 'Cancel',
                //        fromLabel: 'From',
                //        toLabel: 'To',
                //        customRangeLabel: 'Custom',
                //        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                //        monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                //        firstDay: 1
                //    }
                //});

                //弹出框设置
                //$('[data-toggle="popover"]').popover();
                //保存按钮
                $("#savbtn").click(function () {
                    //验证表单
                    var errormsg = "";
                    if ($("#datepicker1").val() == "") {
                        errormsg += "日期必须写!<br/>";
                    }
                    if ($("#customer").attr("code") == "") {
                        errormsg += "客户必须填写!<br/>";
                    }
                    //验证现汇与票据的和与合同分配的金额是否相等  未完

                    var _total = 0;
                    $("#tablebody tr").each(function (i, item) {
                        var _rmb = $.trim($(item).find("td").find("input").val());
                        if (!(_rmb == "" || isNaN(_rmb))) {
                            _total += Number(_rmb);
                        }
                    });

                    if (isNaN($("#Rmb").val()) || isNaN($("#Note").val())) {
                        errormsg += "金额必须为数字!<br/>";
                    }

                    var _total1 = Number($("#Rmb").val()) + Number($("#Note").val());

                    //alert(Number(''));
                    // alert(_total1);
                    if (_total != _total1) {
                        errormsg += "总金额与合同分配金额不相等!<br/>";
                    }

                    if (errormsg != "") {
                        $('#savbtn').popover({ "title": "提示", "content": errormsg, "placement": 'top', html: true });
                        $('#savbtn').popover('show');
                        setTimeout(function () {
                            $('#savbtn').popover('destroy');
                        }, 5000);
                        return;
                    }

                    //封装payinfo
                    var paym = {};
                    paym.CustomerID = $("#customer").attr("code");
                    paym.PayDate = $("#datepicker1").val();
                    if ($("#Note").val() == "") {
                        paym.Rmb = 0;
                    } else {
                        paym.Rmb = $("#Rmb").val();
                    }

                    if ($("#Note").val() == "") {
                        paym.Note = 0;
                    } else {
                        paym.Note = $("#Note").val();
                    }
                    var userinfo = eval("(" + $('#userinfo', parent.document).val() + ")");
                    paym.ComanyID = userinfo.companyid;

                    var paymList = [];
                    paym.List = paymList;
                    $("#tablebody tr").each(function (i, item) {
                        var currmb = $.trim($(item).find("td").find("input").val());
                        if (!(currmb == "" || isNaN(currmb))) {
                            var paymitem = {};
                            paymitem.HCODE = $(item).find("td").eq(0).html();
                            paymitem.CurRmb = currmb;
                            paymitem.XSHCODE = $.trim($(item).find("td").find("select").val());;
                            paymList.push(paymitem);

                        }
                    });
                    //alert(JSON.stringify(paym));
                    var spinner1 = new Spinner(getSpinOpts()).spin(document.getElementById('customerCollapse'));
                    $.ajax({
                        type: 'POST',
                        url: '../Handlers/Customer.ashx',
                        data: { action: 'DoPay', PayInfo: JSON.stringify(paym), UserInfo: JSON.stringify(userinfo) },
                        success: function suc(result) {
                            //alert(JSON.stringify(result));
                            //请求失败跳转到错误页
                            if (result.code != "0") {
                                redirecToErrorPage(result);
                                return;
                            }
                            if (result.data == null || result.data.length <= 0) {
                                $("#tablebody").empty();
                                $("#tablebody").append("无数据");
                                spinner1.stop();
                                return;
                            }
                            //操做成功 清空表单
                            $("#tablebody").empty();
                            $("#datepicker1").val("");
                            $("#Rmb").val("");
                            $("#Note").val("");
                            $("#customer").attr("code", "");
                            $("#customer").val("");
                            spinner1.stop();
                        },
                        dataType: 'JSON'
                    });
                    //****************************
                    //alert(JSON.stringify(paym));
                });
                $("#canbtn").click(function () {
                    $('#customerCollapse').collapse('toggle');
                });
            });
            //删除按钮
            $('#toolbtn_del').click(function () {

                try {

                    //var oTable = $('#dvtable').dataTable();
                    //oTable.fnSetColumnVis(1, false, true);
                    //var table = $('#dvtable').DataTable();
                    //table.column(1).visible(false);
                    alert($("table tr.selected").html());
                    //$('#dvtable').columns.adjust().draw(false);
                } catch (e) {
                    alert(e.message)
                }

            });

            //浏览按钮
            $('#toolbtn_stateview').click(function () {
                var table = $('#dvtable').DataTable();
                table.column(1).visible(false);

            });
            //获取选中行的值
            $('#toolbtn_update').click(function () {
                alert($("table tr.selected td:eq(0)").text());
            });

            //工具栏按钮tooltip设置
            $('[data-toggle="tooltip"]').tooltip();
            //$('[data-toggle="popover"]').popover();
            //客户选择按钮事件绑定
            $('#customer-addon').click(function () {
                $("#myModal").modal();
                var tLength = $("#custoemrtable tr").length;
                if (tLength > 1) {
                    //选中行变色 单行
                    $('table tbody').on('click', 'tr', function () {
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        }
                        else {
                            $('table tr.selected').removeClass('selected');
                            $(this).addClass('selected');
                        }
                    });
                    return;
                }
                //客户弹出层隐藏事件，防止弹出层隐藏后datatables选中行不变色
                $('#myModal').on('hidden.bs.modal', function (e) {
                    //选中行变色 单行
                    $('table tbody').on('click', 'tr', function () {
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        }
                        else {
                            $('table tr.selected').removeClass('selected');
                            $(this).addClass('selected');
                        }
                    });
                })

                var userinfo = eval("(" + $('#userinfo', parent.document).val() + ")");

                //客户datatables加载
                $('#custoemrtable').dataTable({
                    "sPaginationType": "full_numbers",
                    "processing": true,//显示进度条
                    "serverSide": true,//发送服务器请求
                    "ajax": {
                        "url": "../handlers/Customer.ashx",
                        "type": "POST",
                        "data": { Action: 'GetList' }
                    },
                    "columns": [{ "data": "CCODE" }, { "data": "CNAME" }],//"bVisible": false  style="display:none
                    //汉化
                    "language":
                    {
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sZeroRecords": "抱歉， 没有找到",
                        "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                        "sInfoEmpty": "没有数据",
                        "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                        "oPaginate": {
                            "sFirst": "<button class='btn btn-default'><span class='glyphicon glyphicon-step-backward' aria-hidden='true'></span></button>",
                            "sPrevious": "<button class='btn btn-default'><span class='glyphicon glyphicon-chevron-left' aria-hidden='true'></span></button>",
                            "sNext": "<button class='btn btn-default'><span class='glyphicon glyphicon-chevron-right' aria-hidden='true'></span></button>",
                            "sLast": "<button class='btn btn-default'><span class='glyphicon glyphicon-step-forward' aria-hidden='true'></span></button>"
                        },
                        "sZeroRecords": "没有检索到数据",
                        "sProcessing": "<img src='../Images/loading.gif'>加载中...",
                        "sSearch": "查找"
                    },
                    //请求处理函数
                    "fnServerData": function retrieveData(sSource, aoData, fnCallback) {
                        // 将客户名称加入参数数组
                        //aoData.push( { "name": "customerName", "value": "asdas" } );//添加自己的额外参数
                        $.ajax({
                            "type": "POST",
                            "url": "../handlers/Customer.ashx",
                            "dataType": "json",
                            "data": { p: JSON.stringify(aoData), Action: 'GetList', CompanyID: userinfo.CompanyID }, // 以json格式传递
                            "success": function (resp) {
                                //alert(JSON.stringify(resp));
                                fnCallback(resp.data);
                            }
                        });
                    }
                });
                //选中行变色 单行
                $('table tbody').on('click', 'tr', function () {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    }
                    else {
                        $('table tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                });
                $('#customerEnter').click(function () {
                    //未选中客户弹出框提示
                    if ($("table tr.selected td:eq(0)").text() == "") {
                        $('#customerEnter').popover({ 'title': '客户不能为空', 'content': '请单击选择客户', 'placement': 'top' });
                        $('#customerEnter').popover('show');
                        setTimeout(function () {
                            $('#customerEnter').popover('destroy');
                        }, 5000);
                    } else {
                        $("#customer").val($("table tr.selected td:eq(1)").text());
                        $("#customer").attr("code", $("table tr.selected td:eq(0)").text())
                        $("#myModal").modal('hide');

                        var spinner1 = new Spinner(getSpinOpts()).spin(document.getElementById('customerCollapse'));
                        $.ajax({
                            type: 'POST',
                            url: '../Handlers/Customer.ashx',
                            data: { action: 'GetContractByCustomer', CustomerID: $("#customer").attr("code") },
                            success: function suc(result) {
                                //alert(JSON.stringify(result));
                                //请求失败跳转到错误页
                                if (result.code != "0") {
                                    redirecToErrorPage(result);
                                    return;
                                }
                                if (result.data == null || result.data.length <= 0) {
                                    $("#tablebody").empty();
                                    $("#tablebody").append("无数据");
                                    spinner1.stop();
                                    return;
                                }

                                $("#tablebody").empty();
                                //绑定数据
                                for (var i = 0; i < result.data.length; i++) {
                                    var shtml = "";
                                    try {
                                        shtml = shtml.concat("<tr>");
                                        shtml = shtml.concat("<td>" + result.data[i].HCODE + "</td>");
                                        shtml = shtml.concat("<td style='text-align:right'>" + result.data[i].Total + "</td>");
                                        shtml = shtml.concat("<td style='text-align:right'>" + result.data[i].NonRmb + "</td>");
                                        shtml = shtml.concat("<td style='text-align:center'><input type='text' class='form-control text-right' id='currmb' placeholder='" + result.data[i].HCODE + "本次付款金额'></td>");
                                        shtml = shtml.concat("<td style='text-align:center'><select class='selectpicker form-control'>");
                                        //销售合同号下拉列表数据绑定
                                        var xslist = eval("(" + result.data[i].XSHCODE + ")");
                                        for (var j = 0; j < xslist.length; j++) {
                                            shtml = shtml.concat("<option>" + xslist[j] + "</option>");
                                        };
                                        shtml = shtml.concat("</select></td>");
                                        shtml = shtml.concat("</tr>");
                                        $("#tablebody").append(shtml);
                                        $("select.selectpicker").each(function () {
                                        });
                                    } catch (e) {
                                        alert(e.message)
                                    };
                                }
                                spinner1.stop();
                            },
                            dataType: 'JSON'
                        });


                    }

                    //alert($("table tr.selected td:eq(0)").text());
                });
                //弹出提示设置
                //$('[data-toggle="popover"]').popover({ html: true });

            });
        });
    </script>
</head>
<body>
    <div class="panel">
        <div class="panel-heading">
            <!--工具栏-->
            <div class="btn-toolbar" role="toolbar">
                <!--工具栏分组-->
                <div class="btn-group" role="group">
                    <button id="toolbtn_add" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="新增一条记录"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                </div>
                <div class="btn-group" role="group">
                    <button id="toolbtn_update" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="修改选中记录"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></button>
                    <button id="toolbtn_del" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="删除选中记录"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                </div>
                <div class="btn-group" role="group">
                    <button id="toolbtn_stateview" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="查看审批进度"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span></button>
                </div>
            </div>
        </div>
        <div class="panel-body">
            <div class="collapse" id="customerCollapse">
                <!--表单区域-->
                <div class="panel panel-primary">
                    <div class="panel-heading">新增一条记录</div>
                    <div class="panel-body">
                        <!--action很重要！！！！！！！！！！！！！！！！！！！！！！！！！1-->
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="customer" class="control-label col-md-1">客户</label>
                                <div class="input-group col-md-11">
                                    <input disabled id="customer" type="text" class="form-control" placeholder="请选择客户" aria-describedby="customer-addon">
                                    <span class="input-group-btn"><button id="customer-addon" class="btn btn-default" type="button">查找</button></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="rmb1" class="control-label col-md-2">现汇</label>
                                        <div class="col-md-10">
                                            <input type="number" class="form-control" id="Rmb" placeholder="现汇">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rmb1" class="control-label col-md-2">票据</label>
                                        <div class="col-md-10">
                                            <input type="number" class="form-control" id="Note" placeholder="票据">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="datepicker1" class="control-label col-md-1">日期</label>
                                <div class="col-md-11">
                                    <input id="datepicker1" type="date" class="form-control" placeholder="请选择日期">
                                </div>
                            </div>


                            <div class="panel panel-info">
                                <!-- Default panel contents -->
                                <div class="panel-heading">合同信息</div>
                                <!-- Table -->
                                <table id="datalist" class="table  table-hover  table-bordered">
                                    <thead>
                                        <tr><th style='text-align:center'>合同号</th><th style='text-align:center'>金额</th><th style='text-align:center'>未付款</th><th style='text-align:center'>本次</th><th style='text-align:center'>销售合同</th></tr>
                                    </thead>
                                    <tbody id="tablebody">
                                        <!--行模板-->
                                        <!--<tr>
                                            <td>ZD001</td>
                                            <td style='text-align:right'>150,000</td>
                                            <td style='text-align:right'>50,000</td>
                                            <td style='text-align:center'>
                                                <input type="text" class="form-control text-right" id="currmb" placeholder="ZD001付款金额">
                                            </td>
                                            <td style='text-align:center'>
                                                <select class='selectpicker form-control'>
                                                    <option>2012</option>
                                                    <option>2013</option>
                                                </select>
                                            </td>
                                        </tr>-->
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                    <div class="panel-footer">
                        <button id="savbtn" type="button" data-toggle="popover" class="btn btn-primary">&nbsp;&nbsp;&nbsp;保&nbsp;存&nbsp;&nbsp;&nbsp;</button>
                        <button id="canbtn" type="button" class="btn btn-default">&nbsp;&nbsp;&nbsp;取&nbsp;消&nbsp;&nbsp;&nbsp;</button>
                    </div>
                </div>
            </div>

            <table id="dvtable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>客户</th>
                        <th>金额</th>
                        <th>日期</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>客户</th>
                        <th>金额</th>
                        <th>日期</th>
                        <th>状态</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <!--客户弹出层-->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">选择客户</h4>
                </div>
                <div class="modal-body">
                    <div class="panel panel-info">
                        <div class="panel-body">
                            <table id="custoemrtable" class="display" cellspacing="0" width="100%">
                                <thead>
                                    <tr><th>编码</th><th>客户</th></tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="customerEnter" type="button" data-toggle="popover" class="btn btn-primary btn-lg">选中</button>
                    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
