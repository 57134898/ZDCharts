<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="../Content/bootstrap.min.css" rel="stylesheet" />
    <link href="../Content/bootstrap-select.min.css" rel="stylesheet" />
    <link href="../Content/bootstrap-switch/bootstrap3/bootstrap-switch.min.css" rel="stylesheet" />
    <link href="../Content/myStyle.css" rel="stylesheet" />
    <script src="../Scripts/jquery-2.1.3.min.js"></script>
    <script src="../Scripts/bootstrap.min.js"></script>
    <script src="../Scripts/bootstrap-select.min.js"></script>
    <script src="../Scripts/bootstrap-switch.min.js"></script>
    <script src="../Scripts/spin.min.js"></script>
    <script src="../Scripts/myjs.js"></script>
    <script type="text/javascript">
        function listclear() {
            $("#listdiv").empty();
        }
        function loadcompany() {
            //加载中动画开启
            var spinner = new Spinner(getSpinOpts()).spin(document.getElementById('listdiv'));
            //获取待审批单据，绑定到列表
            $.ajax({
                type: 'POST',
                url: '../Handlers/WFFlow.ashx',
                data: { action: 'GetListGbCompany', UserInfo: $(window.parent.document).find("#inputUser").val() },
                success: function suc(result) {
                    //请求失败跳转到错误页
                    if (result.code != "0") {
                        redirecToErrorPage(result);
                        return;
                    }
                    //绑定数据
                    if (result.data == null || result.data.length <= 0) {
                        $("#listdiv").append("无数据");
                        spinner.stop();
                        return;
                    }
                    listclear();
                    for (var i = 0; i < result.data.length; i++) {
                        var shtml = "";
                        shtml = shtml.concat("<a id='" + "a" + i.toString() + "' href='#' class='list-group-item'><span class='badge'>" + result.data[i].Total + "</span>" + result.data[i].Company + "</a>");
                        $("#listdiv").append(shtml);
                        //公司列表单击事件
                        $("#a" + i.toString()).click(function () {
                            loadcustomer();
                        });
                    }
                    spinner.stop();
                },
                dataType: 'JSON'
            });
        }
        function loadcustomer() {
            listclear();
            //加载中动画开启
            var spinner1 = new Spinner(getSpinOpts()).spin(document.getElementById('listdiv'));
            //获取待审批单据，绑定到列表
            $.ajax({
                type: 'POST',
                url: '../Handlers/WFFlow.ashx',
                data: { action: 'GetListGbCustomer', UserInfo: $(window.parent.document).find("#inputUser").val() },
                success: function suc(result) {
                    //请求失败跳转到错误页
                    if (result.code != "0") {
                        redirecToErrorPage(result);
                        return;
                    }
                    if (result.data == null || result.data.length <= 0) {
                        $("#listdiv").append("无数据");
                        spinner1.stop();
                        return;
                    }
                    listclear();
                    //绑定数据
                    for (var i = 0; i < result.data.length; i++) {
                        var shtml = "<a href='javascript:loadcompany();' class='list-group-item list-group-item-success'>返回上级</a>";
                        shtml = shtml.concat("<a id='" + "aa" + i.toString() + "' href='#' class='list-group-item'><span class='badge'>" + result.data[i].Total + "</span>" + result.data[i].Customer + "</a>");
                        $("#listdiv").append(shtml);
                        //switch按钮样式设置
                        $("#aa" + i.toString()).click(function () {
                            loadcontract();
                        });
                    }
                    spinner1.stop();
                },
                dataType: 'JSON'
            });
        }
        function loadcontract() {
            listclear();
            var spinner2 = new Spinner(getSpinOpts()).spin(document.getElementById('listdiv'));
            //获取待审批单据，绑定到列表,客户列表事件
            $.ajax({
                type: 'POST',
                url: '../Handlers/WFFlow.ashx',
                data: { action: 'GetList', UserInfo: $(window.parent.document).find("#inputUser").val() },
                success: function suc(result) {
                    //请求失败跳转到错误页
                    if (result.code != "0") {
                        redirecToErrorPage(result);
                        return;
                    }
                    if (result.data == null || result.data.length <= 0) {
                        $("#listdiv").append("无数据");
                        spinner1.stop();
                        return;
                    }
                    listclear();
                    //绑定数据
                    for (var i = 0; i < result.data.length; i++) {
                        var shtml = "<a href='javascript:loadcustomer();' class='list-group-item list-group-item-success'>返回上级</a>";
                        shtml = shtml.concat("<a class='list-group-item' nodeid='" + result.data[i].FID + "'>");
                        shtml = shtml.concat("<div class='panel panel-primary'>");
                        shtml = shtml.concat("<div class='panel-heading'> <span fid='" + result.data[i].FID + "' class='glyphicon glyphicon-asterisk' aria-hidden='true' result='O'></span>&nbsp;" + result.data[i].Customer + "</div>");
                        shtml = shtml.concat("<div class='panel-body'>");
                        shtml = shtml.concat("<table class='table  table-striped'>");
                        shtml = shtml.concat("<tr><td>公司:</td><td class='numFormat'>" + result.data[i].Company + "</td></tr>");
                        shtml = shtml.concat("<tr><td>合同号:</td><td class='numFormat'>" + result.data[i].HCode + "</td></tr>");
                        shtml = shtml.concat("<tr><td>金额:</td><td class='numFormat'>" + result.data[i].CTotal + "</td></tr>");
                        shtml = shtml.concat("<tr><td>已付:</td><td class='numFormat'>" + result.data[i].Rmb + "</td></tr>");
                        shtml = shtml.concat("<tr><td>发票:</td><td class='numFormat'>" + result.data[i].Voice + "</td></tr>");
                        shtml = shtml.concat("<tr><td>本次:</td><td class='numFormat'><h4><span class='label label-success'>" + result.data[i].CurRmb + "</span></h4></td></tr>");
                        shtml = shtml.concat("<tr><td>标号:</td><td class='numFormat'>" + result.data[i].BidCode + "</td></tr>");
                        shtml = shtml.concat("<tr><td>申请人:</td><td class='numFormat'>" + result.data[i].Creater + "</td></tr>");
                        shtml = shtml.concat("<tr><td>日期:</td><td class='numFormat'>" + result.data[i].CreatedDate + "</td></tr>");
                        shtml = shtml.concat("</table></div>");
                        shtml = shtml.concat("<div class='panel-footer'>");
                        shtml = shtml.concat("<input  avalue='Y' name='c" + i.toString() + "' data-label-text='同意' type='radio' flowid='" + result.data[i].FID + "'>&nbsp;&nbsp;");
                        shtml = shtml.concat("<input  avalue='N' name='c" + i.toString() + "' data-label-text='拒绝' type='radio' flowid='" + result.data[i].FID + "'>");
                        shtml = shtml.concat("</div></div></a>");
                        $("#listdiv").append(shtml);
                        //switch按钮样式设置
                        $("input[type='radio']").bootstrapSwitch();
                        //switch按钮事件
                        $("input[type='radio']").on('switchChange.bootstrapSwitch', function (event, state) {
                            //客户前符号清除
                            var sp = $("span[fid='" + $(this).attr('flowid') + "']");
                            sp.removeClass("glyphicon glyphicon-asterisk");
                            sp.removeClass("glyphicon glyphicon-ok");
                            sp.removeClass("glyphicon glyphicon-remove");
                            //设置对号
                            if ($(this).attr('avalue') == "Y") {
                                sp.addClass("glyphicon glyphicon-ok");
                                sp.attr("result", "Y");
                            }
                            //设置叉
                            if ($(this).attr('avalue') == "N") {
                                sp.addClass("glyphicon glyphicon-remove");
                                sp.attr("result", "N");
                            }
                            //设置首页提交确认按钮数字图标
                            var pcount = $(".glyphicon-ok,.glyphicon-remove").length;
                            if (pcount == 0) {
                                $(window.parent.document).find("#pendspan").text("");
                            } else {
                                $(window.parent.document).find("#pendspan").text($(".glyphicon-ok,.glyphicon-remove").length);
                            }
                        });
                    }
                    spinner2.stop();
                },
                dataType: 'JSON'
            });
        }

        $(document).ready(function () {

            loadcompany();
            return;

            //commit按钮事件
            $("#commitBtn").click(function commit() {
                var pendingdata = $("#curnodeid").val();
                var spinner1 = new Spinner(getSpinOpts()).spin(document.getElementById('agreebtn'));
                $.ajax({
                    type: 'POST',
                    url: '../Handlers/WFFlow.ashx',
                    data: { action: 'Commit', pendingdata: pendingdata },
                    success: function suc(result) {
                        if (result.code != "0") {
                            redirecToErrorPage(result);
                            return;
                        }
                        loadcustomer();
                        spinner1.stop();
                        $('#myModal').modal('hide');
                    },
                    dataType: 'JSON'
                });
            });
            //cannel按钮事件
            $("#cannelBtn").click(function () {
                $('#myModal').modal('hide');
            });
        });
        //弹出审批确认框
        function showmodal() {
            //显示弹出框
            $("#myModal").modal();
            //待审批单据编号与状态获取
            var pendArr = [];
            $("span.glyphicon-ok,.glyphicon-remove").each(function (i, item) {
                var f = {};
                f.fid = $(item).attr("fid");
                if ($(item).attr("result") == "Y") {
                    f.result = "Y";
                }
                if ($(item).attr("result") == "N") {
                    f.result = "N";
                }
                pendArr.push(f);
            });
            //审批需要数据绑定到curnodeid
            $("#curnodeid").val(JSON.stringify(pendArr));
        }
    </script>
</head>
<body style="margin-right:10px">
    <!--审批确认弹出层-->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title" id="myModalLabel">确认</h3>
                </div>
                <div class="modal-body">
                    <input id="curnodeid" type="hidden" />
                    <button id="commitBtn" type="button" class="btn btn-success btn-lg btn-block" onclick="agree()">确定</button>
                    <br />
                    <button id="cannelBtn" type="button" class="btn btn-danger btn-lg btn-block" onclick="refuse()">取消</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="list-group" id="listdiv">


        <a href="#" class="list-group-item active">
            Cras justo odio
        </a>

        <!--行模板-->
        <!--<a href="#" class="list-group-item" nodeid="node1">
            <div class="panel panel-primary">
                <div class="panel-heading">辽宁艾美集团生物疫苗有限公司</div>
                <div class="panel-body">
                    <table class="table  table-striped">
                        <tr><td>合同号:</td><td class="numFormat">AM2015-00021</td></tr>
                        <tr><td>金额:</td><td class="numFormat">3,600,000</td></tr>
                        <tr><td>已付:</td><td class="numFormat">1,600,000</td></tr>
                        <tr><td>发票:</td><td class="numFormat">2,000.000</td></tr>
                        <tr><td>本次:</td><td class="numFormat"><h4><span class="label label-success">400,000</span></h4></td></tr>
                        <tr><td>标号:</td><td class="numFormat">AM2015-11212</td></tr>
                        <tr><td>申请人:</td><td class="numFormat">张三</td></tr>
                        <tr><td>日期:</td><td class="numFormat">2015-1-2</td></tr>
                    </table>
                </div>
                <div class="panel-footer">备注:着急发货，已备案</div>
            </div>
        </a>-->
    </div>
</body>
</html>
